name: Deploy to Server

# å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ã‚’é™å®šã™ã‚‹
on:
  push:
    branches:
      - main
  # pull_request ã¯ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ãŸã‚å‰Šé™¤
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # âš ï¸ é‡è¦: æ¨©é™ã‚’æœ€å°é™ã®èª­ã¿å–ã‚Šã«åˆ¶é™
    permissions:
      contents: read

    steps:
      # 1. actions/checkout ã‚’ç‰¹å®šã‚³ãƒŸãƒƒãƒˆSHAã§å›ºå®š
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # --- ğŸ”‘ æ–°ãŸã«è¿½åŠ ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆãƒ›ã‚¹ãƒˆéµã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å‰Šé™¤ï¼‰---
      - name: Clear old known_hosts (Temporary)
        run: |
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
      # ----------------------------------------------------------------
      - name: Install SSH Key and Validate Known Hosts
        # 2. shimataro/ssh-key-action ã‚’ç‰¹å®šã‚³ãƒŸãƒƒãƒˆSHAã§å›ºå®š
        uses: shimataro/ssh-key-action@8f0e25e199bee71fe79bcde5b1fda02e7831b191
        with:
          key: ${{ secrets.SECRET_SSH_KEY }}
          # 3. ãƒ›ã‚¹ãƒˆéµæ¤œè¨¼ã®ãŸã‚ã«ã€ã‚µãƒ¼ãƒãƒ¼ã®å…¬é–‹éµã‚’ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆåŒ–ï¼ˆæ¨å¥¨ï¼‰
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
          config: |
            Host 162.43.107.10
              User naname
              Port 10022

      - name: Rsync Deploy
        run: rsync -vrlp -e "ssh -p 10022" ./wp-content/ naname@162.43.107.10:/home/naname/naname-lab.net/public_html/wp-content
