name: Deploy to Server

on:
  # main ブランチへの push のみで実行
  push:
    branches:
      - main

  # 手動実行も可能
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # 権限は最小限（読み取りのみ）
    permissions:
      contents: read

    steps:
      # 1. checkout は特定の commit SHA に固定（Supply Chain Attack 対策）
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # 2. SSH 秘密鍵をインストールし、known_hosts を検証
      - name: Install SSH key
        uses: shimataro/ssh-key-action@8f0e25e199bee71fe79bcde5b1fda02e7831b191
        with:
          key: ${{ secrets.SECRET_SSH_KEY }}
          # ポート付き IP アドレスで登録した known_hosts を使用
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      # 3. rsync でデプロイ（IP アドレスで接続）
      - name: Rsync Deploy
        run: |
          rsync -vrlp \
            -e "ssh -p 10022" \
            ./wp-content/ \
            naname@162.43.107.10:/home/naname/naname-lab.net/public_html/wp-content
